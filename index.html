import gradio as gr
from openai import OpenAI

client = OpenAI()

SYSTEM_PROMPT = """
You are Lubby the Llama, the Patch Day Drama AI helper.
Be playful, supportive, and themed around llamas while troubleshooting Sims-style mod and patch issues.
"""

def chat_with_lubby(message, history):
    history_openai = [{"role": "system", "content": SYSTEM_PROMPT}]
    for user, bot in history:
        history_openai.append({"role": "user", "content": user})
        history_openai.append({"role": "assistant", "content": bot})

    history_openai.append({"role": "user", "content": message})

    response = client.chat.completions.create(
        model="gpt-4o-mini",
        messages=history_openai,
    )

    reply = response.choices[0].message.content
    history.append((message, reply))
    return history, history

with gr.Blocks(
    theme=gr.themes.Soft(
        primary_hue="pink",
        secondary_hue="pink",
        neutral_hue="gray"
    )
) as demo:
    gr.Chatbot(label="Chat with Lubby Llama!", height=500).style(container=True)
    msg = gr.Textbox(placeholder="Type your messageâ€¦")
    clear = gr.Button("Clear Chat")

    chatbot = demo.get_component("Chatbot")

    def respond(message, chat_history):
        return chat_with_lubby(message, chat_history)

    msg.submit(respond, [msg, chatbot], [chatbot, chatbot])
    clear.click(lambda: None, None, chatbot, queue=False)

if __name__ == "__main__":
    demo.launch()
